/** @jsx React.DOM */
var TodosApp = (function() {
  var tabs = [
    { id: "review",
      name: "To Review",
      alt: "Patches you have to review (key: r)",
      type: "patches"
    },
    { id: "checkin",
      name: "To Check In",
      alt: "Patches by you, ready to check in (key: c)",
      type: "patches"
    },
    { id: "nag",
      name: "To Nag",
      alt: "Patches by you, awaiting review (key: n)",
      type: "flags+reviews"
    },
    { id: "respond",
      name: "To Respond",
      alt: "Bugs where you're a flag requestee (key: p)",
      type: "flags"
    },
    { id: "fix",
      name: "To Fix",
      alt: "Bugs assigned to you (key: f)",
      type: "bugs"
    }
  ];

  var TodosStorage = {
    get email() {
      return localStorage['bztodos-email'];
    },

    set email(address) {
      localStorage["bztodos-email"] = address;
    },

    get selectedTab() {
      return localStorage['bztodos-selected-tab'];
    },

    set selectedTab(id) {
      localStorage['bztodos-selected-tab'] = id;
    },

    get includeBlockedBugs() {
      // default is true
      return !(localStorage['bztodos-include-blocked-bugs'] === "false");
    },

    set includeBlockedBugs(shouldInclude) {
      localStorage['bztodos-include-blocked-bugs'] = JSON.stringify(shouldInclude);
    }
  }

  var TodosApp = React.createClass({displayName: 'TodosApp',
    handleLoginSubmit: function(email) {
      if (!email || email == TodosStorage.email) {
        return;
      }
      this.setState(this.getInitialState());
      this.setUser(email);
    },

    handleTabSelect: function(listId) {
      if (listId == TodosStorage.selectedTab) {
        return;
      }
      TodosStorage.selectedTab = listId;
      this.setState({selectedTab: listId});
    },

    getInitialState: function() {
      return {
        data: {review: {}, checkin: {}, nag: {}, respond: {}, fix: {}},
        selectedTab: TodosStorage.selectedTab || "review",
        includeBlockedBugs: TodosStorage.includeBlockedBugs
      };
    },

    componentDidMount: function() {
      var email = this.loadUser();
      if (!email) {
        $("#login-container").addClass("logged-out");
        $("#todo-lists").hide();
        $("footer").hide();
      }
      else {
        this.setUser(email);
      }

      // When they switch to another browser tab, mark all items as "seen"
      $(window).blur(function() {
        this.markAsSeen();
        this.updateTitle(0);
      }.bind(this));

      this.addKeyBindings();
      this.setupPreferences();

      // Update the todo lists every so often
      setInterval(this.update, this.props.pollInterval);
    },

    componentDidUpdate: function() {
      // turn timestamps into human times
      $(".timeago").timeago();
    },

    render: function() {
      return (
        React.DOM.div(null, 
          TodosLogin({onLoginSubmit: this.handleLoginSubmit}), 
          TodoTabs({tabs: tabs, data: this.state.data, 
                    selectedTab: this.state.selectedTab, 
                    includeBlockedBugs: this.state.includeBlockedBugs, 
                    onTabSelect: this.handleTabSelect})
        )
      );
    },

    /**
     * Get the user's email from the current url or storage.
     */
    loadUser: function() {
      // first see if the user is specified in the url
      var query = queryFromUrl();
      var email = query['email'];
      if (!email) {
        email = query['user'];
      }
      // if not, fetch the last user from storage
      if (!email) {
        email = TodosStorage.email;
        if (!email) {
          return null;
        }
      }
      return email;
    },

    /**
     * Reset the user by email, fetching new data and updating the lists.
     */
    setUser: function(email) {
      this.user = new BugzillaUser(email);

      TodosStorage.email = email;

      $("#login-container").removeClass("logged-out");
      $("#login-container").addClass("logged-in");
      $("#login-name").val(email);

      $("#welcome-message").hide();
      $("#todo-lists").show();
      $("footer").show();

      this.update();
    },

    /**
     * Fetch new data from Bugzilla and update the todo lists.
     */
    update: function() {
      this.user.fetchTodos(function(data) {
        var count = this.markNew(data);
        this.updateTitle(count);

        this.setState({data: data});
      }.bind(this));
    },

    /**
     * Mark which items in the fetched data are new since last time.
     * We need this to display the count of new items in the tab title
     * and favicon, and to visually highlight the new items in the list.
     */
    markNew: function(newData) {
      var oldData = this.state.data;
      var totalNew = 0; // number of new non-seen items

      for (var id in newData) {
        var newList = newData[id].items;
        var oldList = oldData[id].items;
        var newCount = 0;

        if (!newList || !oldList) {
          continue;
        }
        for (var i in newList) {
          // try to find this item in the old list
          var newItem = newList[i];
          var oldItem = null;
          for (var j in oldList) {
            if (newItem.bug.id == oldList[j].bug.id) {
              oldItem = oldList[j];
              break;
            }
          }
          // mark as new if there was no match in the old list, or
          // there is, but that item hasn't been seen yet by the user.
          var isNew = !oldItem || oldItem.new;
          if (isNew) {
            newCount++;
            totalNew++;
          }
          newItem.new = isNew;
        }
        // cache the count of new items for easy fetching
        newData[id].newCount = newCount;
      }

      return totalNew;
    },

    /**
     * Mark every item as "seen", thus clearing favicon and title counts
     * and removing the highlights from new items.
     */
    markAsSeen: function() {
      // mutate old state briefly
      var data = this.state.data;
      for (var id in data) {
        var list = data[id].items;
        if (!list) {
          continue;
        }

        for (var i in list) {
          list[i].new = false;
        }
      }
      // then reset state to old state but without markers
      this.setState(data);
    },

    /**
     * Update the page title to reflect the number of updates.
     */
    updateTitle: function(updateCount) {
      var title = document.title;
      title = title.replace(/\(\w+\) /, "");

      // update title with the number of new requests
      if (updateCount) {
        title = "(" + updateCount + ") " + title;
      }
      document.title = title;

      // update favicon too
      Tinycon.setBubble(updateCount);
    },

    /**
     * Start listening for key events for changing tabs.
     */
    addKeyBindings: function() {
      var keys = {
        'r': 'review',
        'c': 'checkin',
        'n': 'nag',
        'p': 'respond',
        'f': 'fix',
        'h': 'selectPreviousTab',
        'l': 'selectNextTab',
      };

      $(document).keypress(function(e) {
        if (e.ctrlKey || e.altKey || e.shiftKey || e.metaKey
           || e.target.nodeName.toLowerCase() == "input") {
          return;
        }
        var action = keys[String.fromCharCode(e.charCode)];
        if (!action) {
          return;
        }
        if (this.indexForTab(action) >= 0) {
          return void this.handleTabSelect(action);
        }
        if (typeof this[action] == "function") {
          return void this[action]();
        }
      }.bind(this));

      // Tell the user what keybindings exist.
      var keyInfo = $("#key-info");
      var firstIteration = true;
      for (var key in keys) {
        if (firstIteration) {
          firstIteration = false;
        } else {
          keyInfo.append(", ");
        }
        keyInfo.append($("<code>").append(key));
      }
    },

    selectNextTab: function() {
      this.selectTabRelative(1);
    },

    selectPreviousTab: function() {
      this.selectTabRelative(-1);
    },

    selectTabRelative: function (offset) {
      var N = tabs.length;
      var index = this.indexForTab(this.state.selectedTab);
      var tab = tabs[(index + offset + N) % N];

      this.handleTabSelect(tab.id);
    },

    indexForTab: function(listId) {
      for (var i = 0; i < tabs.length; i++) {
        if (tabs[i].id == listId) {
          return i;
        }
      }
      return -1;
    },

    setupPreferences: function () {
      var checkbox = $("#include-blocked-bugs");
      checkbox.attr("checked", TodosStorage.includeBlockedBugs);
      checkbox.change(this.setIncludeBlockedBugs);
    },

    setIncludeBlockedBugs: function(event) {
      var shouldInclude = event.target.checked;
      TodosStorage.includeBlockedBugs = shouldInclude;

      this.setState({includeBlockedBugs: shouldInclude});
    }
  });

  var TodosLogin = React.createClass({displayName: 'TodosLogin',
    /**
     * Handle login form submission. We're using a form here so we can take
     * advantage of the browser's native autocomplete for remembering emails.
     */
    handleSubmit: function(e) {
      e.preventDefault();

      var email = this.refs.email.getDOMNode().value.trim();
      this.props.onLoginSubmit(email);

      // We do all this so we get the native autocomplete for the email address
      // http://stackoverflow.com/questions/8400269/browser-native-autocomplete-for-ajaxed-forms
      var iFrameWindow = document.getElementById("submit-iframe").contentWindow;
      var cloned = document.getElementById("login-form").cloneNode(true);
      iFrameWindow.document.body.appendChild(cloned);
      var frameForm = iFrameWindow.document.getElementById("login-form");
      frameForm.onsubmit = null;
      frameForm.submit();
      return false;
    },

    componentDidMount: function() {
      var input = $(this.refs.email.getDOMNode());
      input.val(TodosStorage.email);

      input.click(function(){
        this.select();
      });
      // clicking outside of the login should change the user
      input.blur(function() {
        $("#login-form").submit();
      });
      // React won't catch the submission fired from the blur handler
      $("#login-form").submit(this.handleSubmit);
    },

    render: function() {
      return (
        React.DOM.div({id: "login-container"}, 
          React.DOM.span({id: "title"}, 
            React.DOM.img({id: "bug-icon", src: "lib/bugzilla.png", alt: "Bugzilla"}), 
             "Todos"
          ), 
          React.DOM.span({id: "login"}, " for", 
            React.DOM.form({id: "login-form", onSubmit: this.handleSubmit}, 
              React.DOM.input({id: "login-name", 
                     name: "email", placeholder: "Enter Bugzilla user...", 
                     ref: "email"})
            )
          )
        )
      );
    }
  })

  /**
   * Get an object with the query paramaters and values for the current page.
   */
  function queryFromUrl(url) {
    var vars = (url || document.URL).replace(/.+\?/, "").split("&"),
        query = {};
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split("=");
      query[pair[0]] = decodeURIComponent(pair[1]);
    }
    return query;
  }

  return TodosApp;
})();

$(document).ready(function() {
  var interval = 1000 * 60 * 20; // twenty minutes

  React.render(TodosApp({pollInterval: interval}),
               document.getElementById("content"))
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtZWQuanMiLCJzb3VyY2VzIjpbbnVsbF0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHFCQUFxQjtBQUNyQixJQUFJLFFBQVEsR0FBRyxDQUFDLFdBQVc7RUFDekIsSUFBSSxJQUFJLEdBQUc7SUFDVCxFQUFFLEVBQUUsRUFBRSxRQUFRO01BQ1osSUFBSSxFQUFFLFdBQVc7TUFDakIsR0FBRyxFQUFFLHFDQUFxQztNQUMxQyxJQUFJLEVBQUUsU0FBUztLQUNoQjtJQUNELEVBQUUsRUFBRSxFQUFFLFNBQVM7TUFDYixJQUFJLEVBQUUsYUFBYTtNQUNuQixHQUFHLEVBQUUsNENBQTRDO01BQ2pELElBQUksRUFBRSxTQUFTO0tBQ2hCO0lBQ0QsRUFBRSxFQUFFLEVBQUUsS0FBSztNQUNULElBQUksRUFBRSxRQUFRO01BQ2QsR0FBRyxFQUFFLDBDQUEwQztNQUMvQyxJQUFJLEVBQUUsZUFBZTtLQUN0QjtJQUNELEVBQUUsRUFBRSxFQUFFLFNBQVM7TUFDYixJQUFJLEVBQUUsWUFBWTtNQUNsQixHQUFHLEVBQUUsNkNBQTZDO01BQ2xELElBQUksRUFBRSxPQUFPO0tBQ2Q7SUFDRCxFQUFFLEVBQUUsRUFBRSxLQUFLO01BQ1QsSUFBSSxFQUFFLFFBQVE7TUFDZCxHQUFHLEVBQUUsK0JBQStCO01BQ3BDLElBQUksRUFBRSxNQUFNO0tBQ2I7QUFDTCxHQUFHLENBQUM7O0VBRUYsSUFBSSxZQUFZLEdBQUc7SUFDakIsSUFBSSxLQUFLLEdBQUc7TUFDVixPQUFPLFlBQVksQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUMzQyxLQUFLOztJQUVELElBQUksS0FBSyxVQUFVO01BQ2pCLFlBQVksQ0FBQyxlQUFlLENBQUMsR0FBRyxPQUFPLENBQUM7QUFDOUMsS0FBSzs7SUFFRCxJQUFJLFdBQVcsR0FBRztNQUNoQixPQUFPLFlBQVksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2xELEtBQUs7O0lBRUQsSUFBSSxXQUFXLEtBQUs7TUFDbEIsWUFBWSxDQUFDLHNCQUFz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QUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7UUFDM0QsS0FBSyxHQUFHLEVBQUUsQ0FBQztJQUNmLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO01BQ3BDLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7TUFDOUIsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQzlDO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDakIsR0FBRzs7RUFFRCxPQUFPLFFBQVEsQ0FBQztBQUNsQixDQUFDLEdBQUcsQ0FBQzs7QUFFTCxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVc7QUFDN0IsRUFBRSxJQUFJLFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQzs7RUFFOUIsS0FBSyxDQUFDLE1BQU0sQ0FBRSxRQUFRLENBQUEsQ0FBQSxDQUFDLFlBQUEsRUFBWSxDQUFFLFFBQVMsQ0FBRSxDQUFBO2VBQ25DLFFBQVEsQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDbEQsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiogQGpzeCBSZWFjdC5ET00gKi9cbnZhciBUb2Rvc0FwcCA9IChmdW5jdGlvbigpIHtcbiAgdmFyIHRhYnMgPSBbXG4gICAgeyBpZDogXCJyZXZpZXdcIixcbiAgICAgIG5hbWU6IFwiVG8gUmV2aWV3XCIsXG4gICAgICBhbHQ6IFwiUGF0Y2hlcyB5b3UgaGF2ZSB0byByZXZpZXcgKGtleTogcilcIixcbiAgICAgIHR5cGU6IFwicGF0Y2hlc1wiXG4gICAgfSxcbiAgICB7IGlkOiBcImNoZWNraW5cIixcbiAgICAgIG5hbWU6IFwiVG8gQ2hlY2sgSW5cIixcbiAgICAgIGFsdDogXCJQYXRjaGVzIGJ5IHlvdSwgcmVhZHkgdG8gY2hlY2sgaW4gKGtleTogYylcIixcbiAgICAgIHR5cGU6IFwicGF0Y2hlc1wiXG4gICAgfSxcbiAgICB7IGlkOiBcIm5hZ1wiLFxuICAgICAgbmFtZTogXCJUbyBOYWdcIixcbiAgICAgIGFsdDogXCJQYXRjaGVzIGJ5IHlvdSwgYXdhaXRpbmcgcmV2aWV3IChrZXk6IG4pXCIsXG4gICAgICB0eXBlOiBcImZsYWdzK3Jldmlld3NcIlxuICAgIH0sXG4gICAgeyBpZDogXCJyZXNwb25kXCIsXG4gICAgICBuYW1lOiBcIlRvIFJlc3BvbmRcIixcbiAgICAgIGFsdDogXCJCdWdzIHdoZXJlIHlvdSdyZSBhIGZsYWcgcmVxdWVzdGVlIChrZXk6IHApXCIsXG4gICAgICB0eXBlOiBcImZsYWdzXCJcbiAgICB9LFxuICAgIHsgaWQ6IFwiZml4XCIsXG4gICAgICBuYW1lOiBcIlRvIEZpeFwiLFxuICAgICAgYWx0OiBcIkJ1Z3MgYXNzaWduZWQgdG8geW91IChrZXk6IGYpXCIsXG4gICAgICB0eXBlOiBcImJ1Z3NcIlxuICAgIH1cbiAgXTtcblxuICB2YXIgVG9kb3NTdG9yYWdlID0ge1xuICAgIGdldCBlbWFpbCgpIHtcbiAgICAgIHJldHVybiBsb2NhbFN0b3JhZ2VbJ2J6dG9kb3MtZW1haWwnXTtcbiAgICB9LFxuXG4gICAgc2V0IGVtYWlsKGFkZHJlc3MpIHtcbiAgICAgIGxvY2FsU3RvcmFnZVtcImJ6dG9kb3MtZW1haWxcIl0gPSBhZGRyZXNzO1xuICAgIH0sXG5cbiAgICBnZXQgc2VsZWN0ZWRUYWIoKSB7XG4gICAgICByZXR1cm4gbG9jYWxTdG9yYWdlWydienRvZG9zLXNlbGVjdGVkLXRhYiddO1xuICAgIH0sXG5cbiAgICBzZXQgc2VsZWN0ZWRUYWIoaWQpIHtcbiAgICAgIGxvY2FsU3RvcmFnZVsnYnp0b2Rvcy1zZWxlY3RlZC10YWInXSA9IGlkO1xuICAgIH0sXG5cbiAgICBnZXQgaW5jbHVkZUJsb2NrZWRCdWdzKCkge1xuICAgICAgLy8gZGVmYXVsdCBpcyB0cnVlXG4gICAgICByZXR1cm4gIShsb2NhbFN0b3JhZ2VbJ2J6dG9kb3MtaW5jbHVkZS1ibG9ja2VkLWJ1Z3MnXSA9PT0gXCJmYWxzZVwiKTtcbiAgICB9LFxuXG4gICAgc2V0IGluY2x1ZGVCbG9ja2VkQnVncyhzaG91bGRJbmNsdWRlKSB7XG4gICAgICBsb2NhbFN0b3JhZ2VbJ2J6dG9kb3MtaW5jbHVkZS1ibG9ja2VkLWJ1Z3MnXSA9IEpTT04uc3RyaW5naWZ5KHNob3VsZEluY2x1ZGUpO1xuICAgIH1cbiAgfVxuXG4gIHZhciBUb2Rvc0FwcCA9IFJlYWN0LmNyZWF0ZUNsYXNzKHtcbiAgICBoYW5kbGVMb2dpblN1Ym1pdDogZnVuY3Rpb24oZW1haWwpIHtcbiAgICAgIGlmICghZW1haWwgfHwgZW1haWwgPT0gVG9kb3NTdG9yYWdlLmVtYWlsKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHRoaXMuc2V0U3RhdGUodGhpcy5nZXRJbml0aWFsU3RhdGUoKSk7XG4gICAgICB0aGlzLnNldFVzZXIoZW1haWwpO1xuICAgIH0sXG5cbiAgICBoYW5kbGVUYWJTZWxlY3Q6IGZ1bmN0aW9uKGxpc3RJZCkge1xuICAgICAgaWYgKGxpc3RJZCA9PSBUb2Rvc1N0b3JhZ2Uuc2VsZWN0ZWRUYWIpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgVG9kb3NTdG9yYWdlLnNlbGVjdGVkVGFiID0gbGlzdElkO1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7c2VsZWN0ZWRUYWI6IGxpc3RJZH0pO1xuICAgIH0sXG5cbiAgICBnZXRJbml0aWFsU3RhdGU6IGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZGF0YToge3Jldmlldzoge30sIGNoZWNraW46IHt9LCBuYWc6IHt9LCByZXNwb25kOiB7fSwgZml4OiB7fX0sXG4gICAgICAgIHNlbGVjdGVkVGFiOiBUb2Rvc1N0b3JhZ2Uuc2VsZWN0ZWRUYWIgfHwgXCJyZXZpZXdcIixcbiAgICAgICAgaW5jbHVkZUJsb2NrZWRCdWdzOiBUb2Rvc1N0b3JhZ2UuaW5jbHVkZUJsb2NrZWRCdWdzXG4gICAgICB9O1xuICAgIH0sXG5cbiAgICBjb21wb25lbnREaWRNb3VudDogZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgZW1haWwgPSB0aGlzLmxvYWRVc2VyKCk7XG4gICAgICBpZiAoIWVtYWlsKSB7XG4gICAgICAgICQoXCIjbG9naW4tY29udGFpbmVyXCIpLmFkZENsYXNzKFwibG9nZ2VkLW91dFwiKTtcbiAgICAgICAgJChcIiN0b2RvLWxpc3RzXCIpLmhpZGUoKTtcbiAgICAgICAgJChcImZvb3RlclwiKS5oaWRlKCk7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgdGhpcy5zZXRVc2VyKGVtYWlsKTtcbiAgICAgIH1cblxuICAgICAgLy8gV2hlbiB0aGV5IHN3aXRjaCB0byBhbm90aGVyIGJyb3dzZXIgdGFiLCBtYXJrIGFsbCBpdGVtcyBhcyBcInNlZW5cIlxuICAgICAgJCh3aW5kb3cpLmJsdXIoZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMubWFya0FzU2VlbigpO1xuICAgICAgICB0aGlzLnVwZGF0ZVRpdGxlKDApO1xuICAgICAgfS5iaW5kKHRoaXMpKTtcblxuICAgICAgdGhpcy5hZGRLZXlCaW5kaW5ncygpO1xuICAgICAgdGhpcy5zZXR1cFByZWZlcmVuY2VzKCk7XG5cbiAgICAgIC8vIFVwZGF0ZSB0aGUgdG9kbyBsaXN0cyBldmVyeSBzbyBvZnRlblxuICAgICAgc2V0SW50ZXJ2YWwodGhpcy51cGRhdGUsIHRoaXMucHJvcHMucG9sbEludGVydmFsKTtcbiAgICB9LFxuXG4gICAgY29tcG9uZW50RGlkVXBkYXRlOiBmdW5jdGlvbigpIHtcbiAgICAgIC8vIHR1cm4gdGltZXN0YW1wcyBpbnRvIGh1bWFuIHRpbWVzXG4gICAgICAkKFwiLnRpbWVhZ29cIikudGltZWFnbygpO1xuICAgIH0sXG5cbiAgICByZW5kZXI6IGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgPGRpdj5cbiAgICAgICAgICA8VG9kb3NMb2dpbiBvbkxvZ2luU3VibWl0PXt0aGlzLmhhbmRsZUxvZ2luU3VibWl0fS8+XG4gICAgICAgICAgPFRvZG9UYWJzIHRhYnM9e3RhYnN9IGRhdGE9e3RoaXMuc3RhdGUuZGF0YX1cbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRUYWI9e3RoaXMuc3RhdGUuc2VsZWN0ZWRUYWJ9XG4gICAgICAgICAgICAgICAgICAgIGluY2x1ZGVCbG9ja2VkQnVncz17dGhpcy5zdGF0ZS5pbmNsdWRlQmxvY2tlZEJ1Z3N9XG4gICAgICAgICAgICAgICAgICAgIG9uVGFiU2VsZWN0PXt0aGlzLmhhbmRsZVRhYlNlbGVjdH0vPlxuICAgICAgICA8L2Rpdj5cbiAgICAgICk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgdXNlcidzIGVtYWlsIGZyb20gdGhlIGN1cnJlbnQgdXJsIG9yIHN0b3JhZ2UuXG4gICAgICovXG4gICAgbG9hZFVzZXI6IGZ1bmN0aW9uKCkge1xuICAgICAgLy8gZmlyc3Qgc2VlIGlmIHRoZSB1c2VyIGlzIHNwZWNpZmllZCBpbiB0aGUgdXJsXG4gICAgICB2YXIgcXVlcnkgPSBxdWVyeUZyb21VcmwoKTtcbiAgICAgIHZhciBlbWFpbCA9IHF1ZXJ5WydlbWFpbCddO1xuICAgICAgaWYgKCFlbWFpbCkge1xuICAgICAgICBlbWFpbCA9IHF1ZXJ5Wyd1c2VyJ107XG4gICAgICB9XG4gICAgICAvLyBpZiBub3QsIGZldGNoIHRoZSBsYXN0IHVzZXIgZnJvbSBzdG9yYWdlXG4gICAgICBpZiAoIWVtYWlsKSB7XG4gICAgICAgIGVtYWlsID0gVG9kb3NTdG9yYWdlLmVtYWlsO1xuICAgICAgICBpZiAoIWVtYWlsKSB7XG4gICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBlbWFpbDtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUmVzZXQgdGhlIHVzZXIgYnkgZW1haWwsIGZldGNoaW5nIG5ldyBkYXRhIGFuZCB1cGRhdGluZyB0aGUgbGlzdHMuXG4gICAgICovXG4gICAgc2V0VXNlcjogZnVuY3Rpb24oZW1haWwpIHtcbiAgICAgIHRoaXMudXNlciA9IG5ldyBCdWd6aWxsYVVzZXIoZW1haWwpO1xuXG4gICAgICBUb2Rvc1N0b3JhZ2UuZW1haWwgPSBlbWFpbDtcblxuICAgICAgJChcIiNsb2dpbi1jb250YWluZXJcIikucmVtb3ZlQ2xhc3MoXCJsb2dnZWQtb3V0XCIpO1xuICAgICAgJChcIiNsb2dpbi1jb250YWluZXJcIikuYWRkQ2xhc3MoXCJsb2dnZWQtaW5cIik7XG4gICAgICAkKFwiI2xvZ2luLW5hbWVcIikudmFsKGVtYWlsKTtcblxuICAgICAgJChcIiN3ZWxjb21lLW1lc3NhZ2VcIikuaGlkZSgpO1xuICAgICAgJChcIiN0b2RvLWxpc3RzXCIpLnNob3coKTtcbiAgICAgICQoXCJmb290ZXJcIikuc2hvdygpO1xuXG4gICAgICB0aGlzLnVwZGF0ZSgpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBGZXRjaCBuZXcgZGF0YSBmcm9tIEJ1Z3ppbGxhIGFuZCB1cGRhdGUgdGhlIHRvZG8gbGlzdHMuXG4gICAgICovXG4gICAgdXBkYXRlOiBmdW5jdGlvbigpIHtcbiAgICAgIHRoaXMudXNlci5mZXRjaFRvZG9zKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgdmFyIGNvdW50ID0gdGhpcy5tYXJrTmV3KGRhdGEpO1xuICAgICAgICB0aGlzLnVwZGF0ZVRpdGxlKGNvdW50KTtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHtkYXRhOiBkYXRhfSk7XG4gICAgICB9LmJpbmQodGhpcykpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBNYXJrIHdoaWNoIGl0ZW1zIGluIHRoZSBmZXRjaGVkIGRhdGEgYXJlIG5ldyBzaW5jZSBsYXN0IHRpbWUuXG4gICAgICogV2UgbmVlZCB0aGlzIHRvIGRpc3BsYXkgdGhlIGNvdW50IG9mIG5ldyBpdGVtcyBpbiB0aGUgdGFiIHRpdGxlXG4gICAgICogYW5kIGZhdmljb24sIGFuZCB0byB2aXN1YWxseSBoaWdobGlnaHQgdGhlIG5ldyBpdGVtcyBpbiB0aGUgbGlzdC5cbiAgICAgKi9cbiAgICBtYXJrTmV3OiBmdW5jdGlvbihuZXdEYXRhKSB7XG4gICAgICB2YXIgb2xkRGF0YSA9IHRoaXMuc3RhdGUuZGF0YTtcbiAgICAgIHZhciB0b3RhbE5ldyA9IDA7IC8vIG51bWJlciBvZiBuZXcgbm9uLXNlZW4gaXRlbXNcblxuICAgICAgZm9yICh2YXIgaWQgaW4gbmV3RGF0YSkge1xuICAgICAgICB2YXIgbmV3TGlzdCA9IG5ld0RhdGFbaWRdLml0ZW1zO1xuICAgICAgICB2YXIgb2xkTGlzdCA9IG9sZERhdGFbaWRdLml0ZW1zO1xuICAgICAgICB2YXIgbmV3Q291bnQgPSAwO1xuXG4gICAgICAgIGlmICghbmV3TGlzdCB8fCAhb2xkTGlzdCkge1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGkgaW4gbmV3TGlzdCkge1xuICAgICAgICAgIC8vIHRyeSB0byBmaW5kIHRoaXMgaXRlbSBpbiB0aGUgb2xkIGxpc3RcbiAgICAgICAgICB2YXIgbmV3SXRlbSA9IG5ld0xpc3RbaV07XG4gICAgICAgICAgdmFyIG9sZEl0ZW0gPSBudWxsO1xuICAgICAgICAgIGZvciAodmFyIGogaW4gb2xkTGlzdCkge1xuICAgICAgICAgICAgaWYgKG5ld0l0ZW0uYnVnLmlkID09IG9sZExpc3Rbal0uYnVnLmlkKSB7XG4gICAgICAgICAgICAgIG9sZEl0ZW0gPSBvbGRMaXN0W2pdO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gbWFyayBhcyBuZXcgaWYgdGhlcmUgd2FzIG5vIG1hdGNoIGluIHRoZSBvbGQgbGlzdCwgb3JcbiAgICAgICAgICAvLyB0aGVyZSBpcywgYnV0IHRoYXQgaXRlbSBoYXNuJ3QgYmVlbiBzZWVuIHlldCBieSB0aGUgdXNlci5cbiAgICAgICAgICB2YXIgaXNOZXcgPSAhb2xkSXRlbSB8fCBvbGRJdGVtLm5ldztcbiAgICAgICAgICBpZiAoaXNOZXcpIHtcbiAgICAgICAgICAgIG5ld0NvdW50Kys7XG4gICAgICAgICAgICB0b3RhbE5ldysrO1xuICAgICAgICAgIH1cbiAgICAgICAgICBuZXdJdGVtLm5ldyA9IGlzTmV3O1xuICAgICAgICB9XG4gICAgICAgIC8vIGNhY2hlIHRoZSBjb3VudCBvZiBuZXcgaXRlbXMgZm9yIGVhc3kgZmV0Y2hpbmdcbiAgICAgICAgbmV3RGF0YVtpZF0ubmV3Q291bnQgPSBuZXdDb3VudDtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRvdGFsTmV3O1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBNYXJrIGV2ZXJ5IGl0ZW0gYXMgXCJzZWVuXCIsIHRodXMgY2xlYXJpbmcgZmF2aWNvbiBhbmQgdGl0bGUgY291bnRzXG4gICAgICogYW5kIHJlbW92aW5nIHRoZSBoaWdobGlnaHRzIGZyb20gbmV3IGl0ZW1zLlxuICAgICAqL1xuICAgIG1hcmtBc1NlZW46IGZ1bmN0aW9uKCkge1xuICAgICAgLy8gbXV0YXRlIG9sZCBzdGF0ZSBicmllZmx5XG4gICAgICB2YXIgZGF0YSA9IHRoaXMuc3RhdGUuZGF0YTtcbiAgICAgIGZvciAodmFyIGlkIGluIGRhdGEpIHtcbiAgICAgICAgdmFyIGxpc3QgPSBkYXRhW2lkXS5pdGVtcztcbiAgICAgICAgaWYgKCFsaXN0KSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKHZhciBpIGluIGxpc3QpIHtcbiAgICAgICAgICBsaXN0W2ldLm5ldyA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyB0aGVuIHJlc2V0IHN0YXRlIHRvIG9sZCBzdGF0ZSBidXQgd2l0aG91dCBtYXJrZXJzXG4gICAgICB0aGlzLnNldFN0YXRlKGRhdGEpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgdGhlIHBhZ2UgdGl0bGUgdG8gcmVmbGVjdCB0aGUgbnVtYmVyIG9mIHVwZGF0ZXMuXG4gICAgICovXG4gICAgdXBkYXRlVGl0bGU6IGZ1bmN0aW9uKHVwZGF0ZUNvdW50KSB7XG4gICAgICB2YXIgdGl0bGUgPSBkb2N1bWVudC50aXRsZTtcbiAgICAgIHRpdGxlID0gdGl0bGUucmVwbGFjZSgvXFwoXFx3K1xcKSAvLCBcIlwiKTtcblxuICAgICAgLy8gdXBkYXRlIHRpdGxlIHdpdGggdGhlIG51bWJlciBvZiBuZXcgcmVxdWVzdHNcbiAgICAgIGlmICh1cGRhdGVDb3VudCkge1xuICAgICAgICB0aXRsZSA9IFwiKFwiICsgdXBkYXRlQ291bnQgKyBcIikgXCIgKyB0aXRsZTtcbiAgICAgIH1cbiAgICAgIGRvY3VtZW50LnRpdGxlID0gdGl0bGU7XG5cbiAgICAgIC8vIHVwZGF0ZSBmYXZpY29uIHRvb1xuICAgICAgVGlueWNvbi5zZXRCdWJibGUodXBkYXRlQ291bnQpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBsaXN0ZW5pbmcgZm9yIGtleSBldmVudHMgZm9yIGNoYW5naW5nIHRhYnMuXG4gICAgICovXG4gICAgYWRkS2V5QmluZGluZ3M6IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGtleXMgPSB7XG4gICAgICAgICdyJzogJ3JldmlldycsXG4gICAgICAgICdjJzogJ2NoZWNraW4nLFxuICAgICAgICAnbic6ICduYWcnLFxuICAgICAgICAncCc6ICdyZXNwb25kJyxcbiAgICAgICAgJ2YnOiAnZml4JyxcbiAgICAgICAgJ2gnOiAnc2VsZWN0UHJldmlvdXNUYWInLFxuICAgICAgICAnbCc6ICdzZWxlY3ROZXh0VGFiJyxcbiAgICAgIH07XG5cbiAgICAgICQoZG9jdW1lbnQpLmtleXByZXNzKGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgaWYgKGUuY3RybEtleSB8fCBlLmFsdEtleSB8fCBlLnNoaWZ0S2V5IHx8IGUubWV0YUtleVxuICAgICAgICAgICB8fCBlLnRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09IFwiaW5wdXRcIikge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgYWN0aW9uID0ga2V5c1tTdHJpbmcuZnJvbUNoYXJDb2RlKGUuY2hhckNvZGUpXTtcbiAgICAgICAgaWYgKCFhY3Rpb24pIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuaW5kZXhGb3JUYWIoYWN0aW9uKSA+PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIHZvaWQgdGhpcy5oYW5kbGVUYWJTZWxlY3QoYWN0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIHRoaXNbYWN0aW9uXSA9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICByZXR1cm4gdm9pZCB0aGlzW2FjdGlvbl0oKTtcbiAgICAgICAgfVxuICAgICAgfS5iaW5kKHRoaXMpKTtcblxuICAgICAgLy8gVGVsbCB0aGUgdXNlciB3aGF0IGtleWJpbmRpbmdzIGV4aXN0LlxuICAgICAgdmFyIGtleUluZm8gPSAkKFwiI2tleS1pbmZvXCIpO1xuICAgICAgdmFyIGZpcnN0SXRlcmF0aW9uID0gdHJ1ZTtcbiAgICAgIGZvciAodmFyIGtleSBpbiBrZXlzKSB7XG4gICAgICAgIGlmIChmaXJzdEl0ZXJhdGlvbikge1xuICAgICAgICAgIGZpcnN0SXRlcmF0aW9uID0gZmFsc2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAga2V5SW5mby5hcHBlbmQoXCIsIFwiKTtcbiAgICAgICAgfVxuICAgICAgICBrZXlJbmZvLmFwcGVuZCgkKFwiPGNvZGU+XCIpLmFwcGVuZChrZXkpKTtcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgc2VsZWN0TmV4dFRhYjogZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLnNlbGVjdFRhYlJlbGF0aXZlKDEpO1xuICAgIH0sXG5cbiAgICBzZWxlY3RQcmV2aW91c1RhYjogZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLnNlbGVjdFRhYlJlbGF0aXZlKC0xKTtcbiAgICB9LFxuXG4gICAgc2VsZWN0VGFiUmVsYXRpdmU6IGZ1bmN0aW9uIChvZmZzZXQpIHtcbiAgICAgIHZhciBOID0gdGFicy5sZW5ndGg7XG4gICAgICB2YXIgaW5kZXggPSB0aGlzLmluZGV4Rm9yVGFiKHRoaXMuc3RhdGUuc2VsZWN0ZWRUYWIpO1xuICAgICAgdmFyIHRhYiA9IHRhYnNbKGluZGV4ICsgb2Zmc2V0ICsgTikgJSBOXTtcblxuICAgICAgdGhpcy5oYW5kbGVUYWJTZWxlY3QodGFiLmlkKTtcbiAgICB9LFxuXG4gICAgaW5kZXhGb3JUYWI6IGZ1bmN0aW9uKGxpc3RJZCkge1xuICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0YWJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmICh0YWJzW2ldLmlkID09IGxpc3RJZCkge1xuICAgICAgICAgIHJldHVybiBpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gLTE7XG4gICAgfSxcblxuICAgIHNldHVwUHJlZmVyZW5jZXM6IGZ1bmN0aW9uICgpIHtcbiAgICAgIHZhciBjaGVja2JveCA9ICQoXCIjaW5jbHVkZS1ibG9ja2VkLWJ1Z3NcIik7XG4gICAgICBjaGVja2JveC5hdHRyKFwiY2hlY2tlZFwiLCBUb2Rvc1N0b3JhZ2UuaW5jbHVkZUJsb2NrZWRCdWdzKTtcbiAgICAgIGNoZWNrYm94LmNoYW5nZSh0aGlzLnNldEluY2x1ZGVCbG9ja2VkQnVncyk7XG4gICAgfSxcblxuICAgIHNldEluY2x1ZGVCbG9ja2VkQnVnczogZnVuY3Rpb24oZXZlbnQpIHtcbiAgICAgIHZhciBzaG91bGRJbmNsdWRlID0gZXZlbnQudGFyZ2V0LmNoZWNrZWQ7XG4gICAgICBUb2Rvc1N0b3JhZ2UuaW5jbHVkZUJsb2NrZWRCdWdzID0gc2hvdWxkSW5jbHVkZTtcblxuICAgICAgdGhpcy5zZXRTdGF0ZSh7aW5jbHVkZUJsb2NrZWRCdWdzOiBzaG91bGRJbmNsdWRlfSk7XG4gICAgfVxuICB9KTtcblxuICB2YXIgVG9kb3NMb2dpbiA9IFJlYWN0LmNyZWF0ZUNsYXNzKHtcbiAgICAvKipcbiAgICAgKiBIYW5kbGUgbG9naW4gZm9ybSBzdWJtaXNzaW9uLiBXZSdyZSB1c2luZyBhIGZvcm0gaGVyZSBzbyB3ZSBjYW4gdGFrZVxuICAgICAqIGFkdmFudGFnZSBvZiB0aGUgYnJvd3NlcidzIG5hdGl2ZSBhdXRvY29tcGxldGUgZm9yIHJlbWVtYmVyaW5nIGVtYWlscy5cbiAgICAgKi9cbiAgICBoYW5kbGVTdWJtaXQ6IGZ1bmN0aW9uKGUpIHtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgdmFyIGVtYWlsID0gdGhpcy5yZWZzLmVtYWlsLmdldERPTU5vZGUoKS52YWx1ZS50cmltKCk7XG4gICAgICB0aGlzLnByb3BzLm9uTG9naW5TdWJtaXQoZW1haWwpO1xuXG4gICAgICAvLyBXZSBkbyBhbGwgdGhpcyBzbyB3ZSBnZXQgdGhlIG5hdGl2ZSBhdXRvY29tcGxldGUgZm9yIHRoZSBlbWFpbCBhZGRyZXNzXG4gICAgICAvLyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzg0MDAyNjkvYnJvd3Nlci1uYXRpdmUtYXV0b2NvbXBsZXRlLWZvci1hamF4ZWQtZm9ybXNcbiAgICAgIHZhciBpRnJhbWVXaW5kb3cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInN1Ym1pdC1pZnJhbWVcIikuY29udGVudFdpbmRvdztcbiAgICAgIHZhciBjbG9uZWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImxvZ2luLWZvcm1cIikuY2xvbmVOb2RlKHRydWUpO1xuICAgICAgaUZyYW1lV2luZG93LmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoY2xvbmVkKTtcbiAgICAgIHZhciBmcmFtZUZvcm0gPSBpRnJhbWVXaW5kb3cuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJsb2dpbi1mb3JtXCIpO1xuICAgICAgZnJhbWVGb3JtLm9uc3VibWl0ID0gbnVsbDtcbiAgICAgIGZyYW1lRm9ybS5zdWJtaXQoKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9LFxuXG4gICAgY29tcG9uZW50RGlkTW91bnQ6IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGlucHV0ID0gJCh0aGlzLnJlZnMuZW1haWwuZ2V0RE9NTm9kZSgpKTtcbiAgICAgIGlucHV0LnZhbChUb2Rvc1N0b3JhZ2UuZW1haWwpO1xuXG4gICAgICBpbnB1dC5jbGljayhmdW5jdGlvbigpe1xuICAgICAgICB0aGlzLnNlbGVjdCgpO1xuICAgICAgfSk7XG4gICAgICAvLyBjbGlja2luZyBvdXRzaWRlIG9mIHRoZSBsb2dpbiBzaG91bGQgY2hhbmdlIHRoZSB1c2VyXG4gICAgICBpbnB1dC5ibHVyKGZ1bmN0aW9uKCkge1xuICAgICAgICAkKFwiI2xvZ2luLWZvcm1cIikuc3VibWl0KCk7XG4gICAgICB9KTtcbiAgICAgIC8vIFJlYWN0IHdvbid0IGNhdGNoIHRoZSBzdWJtaXNzaW9uIGZpcmVkIGZyb20gdGhlIGJsdXIgaGFuZGxlclxuICAgICAgJChcIiNsb2dpbi1mb3JtXCIpLnN1Ym1pdCh0aGlzLmhhbmRsZVN1Ym1pdCk7XG4gICAgfSxcblxuICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8ZGl2IGlkPVwibG9naW4tY29udGFpbmVyXCI+XG4gICAgICAgICAgPHNwYW4gaWQ9XCJ0aXRsZVwiPlxuICAgICAgICAgICAgPGltZyBpZD1cImJ1Zy1pY29uXCIgc3JjPVwibGliL2J1Z3ppbGxhLnBuZ1wiIGFsdD1cIkJ1Z3ppbGxhXCI+PC9pbWc+XG4gICAgICAgICAgICAgVG9kb3NcbiAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgPHNwYW4gaWQ9XCJsb2dpblwiPiBmb3JcbiAgICAgICAgICAgIDxmb3JtIGlkPVwibG9naW4tZm9ybVwiIG9uU3VibWl0PXt0aGlzLmhhbmRsZVN1Ym1pdH0+XG4gICAgICAgICAgICAgIDxpbnB1dCBpZD1cImxvZ2luLW5hbWVcIlxuICAgICAgICAgICAgICAgICAgICAgbmFtZT1cImVtYWlsXCIgcGxhY2Vob2xkZXI9XCJFbnRlciBCdWd6aWxsYSB1c2VyLi4uXCJcbiAgICAgICAgICAgICAgICAgICAgIHJlZj1cImVtYWlsXCIvPlxuICAgICAgICAgICAgPC9mb3JtPlxuICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgPC9kaXY+XG4gICAgICApO1xuICAgIH1cbiAgfSlcblxuICAvKipcbiAgICogR2V0IGFuIG9iamVjdCB3aXRoIHRoZSBxdWVyeSBwYXJhbWF0ZXJzIGFuZCB2YWx1ZXMgZm9yIHRoZSBjdXJyZW50IHBhZ2UuXG4gICAqL1xuICBmdW5jdGlvbiBxdWVyeUZyb21VcmwodXJsKSB7XG4gICAgdmFyIHZhcnMgPSAodXJsIHx8IGRvY3VtZW50LlVSTCkucmVwbGFjZSgvLitcXD8vLCBcIlwiKS5zcGxpdChcIiZcIiksXG4gICAgICAgIHF1ZXJ5ID0ge307XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICB2YXIgcGFpciA9IHZhcnNbaV0uc3BsaXQoXCI9XCIpO1xuICAgICAgcXVlcnlbcGFpclswXV0gPSBkZWNvZGVVUklDb21wb25lbnQocGFpclsxXSk7XG4gICAgfVxuICAgIHJldHVybiBxdWVyeTtcbiAgfVxuXG4gIHJldHVybiBUb2Rvc0FwcDtcbn0pKCk7XG5cbiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCkge1xuICB2YXIgaW50ZXJ2YWwgPSAxMDAwICogNjAgKiAyMDsgLy8gdHdlbnR5IG1pbnV0ZXNcblxuICBSZWFjdC5yZW5kZXIoPFRvZG9zQXBwIHBvbGxJbnRlcnZhbD17aW50ZXJ2YWx9Lz4sXG4gICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImNvbnRlbnRcIikpXG59KTtcbiJdfQ==