/** @jsx React.DOM */
var TodosApp = (function() {
  var tabs = [
    { id: "review",
      name: "To Review",
      alt: "Patches you have to review (key: r)",
      type: "patches"
    },
    { id: "checkin",
      name: "To Check In",
      alt: "Patches by you, ready to check in (key: c)",
      type: "patches"
    },
    { id: "nag",
      name: "To Nag",
      alt: "Patches by you, awaiting review (key: n)",
      type: "flags+reviews"
    },
    { id: "respond",
      name: "To Respond",
      alt: "Bugs where you're a flag requestee (key: p)",
      type: "flags"
    },
    { id: "fix",
      name: "To Fix",
      alt: "Bugs assigned to you (key: f)",
      type: "bugs"
    }
  ];

  var TodosStorage = {
    get email() {
      return localStorage['bztodos-email'];
    },

    set email(address) {
      localStorage["bztodos-email"] = address;
    },

    get selectedTab() {
      return localStorage['bztodos-selected-tab'];
    },

    set selectedTab(id) {
      localStorage['bztodos-selected-tab'] = id;
    },

    get includeBlockedBugs() {
      // default is true
      return !(localStorage['bztodos-include-blocked-bugs'] === "false");
    },

    set includeBlockedBugs(shouldInclude) {
      localStorage['bztodos-include-blocked-bugs'] = JSON.stringify(shouldInclude);
    }
  }

  var TodosApp = React.createClass({displayName: 'TodosApp',
    handleLoginSubmit: function(email) {
      if (!email || email == TodosStorage.email) {
        return;
      }
      this.setState(this.getInitialState());
      this.setUser(email);
    },

    handleTabSelect: function(listId) {
      if (listId == TodosStorage.selectedTab) {
        return;
      }
      TodosStorage.selectedTab = listId;
      this.setState({selectedTab: listId});
    },

    getInitialState: function() {
      return {
        data: {review: {}, checkin: {}, nag: {}, respond: {}, fix: {}},
        selectedTab: TodosStorage.selectedTab || "review",
        includeBlockedBugs: TodosStorage.includeBlockedBugs
      };
    },

    componentDidMount: function() {
      var email = this.loadUser();
      if (!email) {
        $("#login-container").addClass("logged-out");
        $("#todo-lists").hide();
        $("footer").hide();
      }
      else {
        this.setUser(email);
      }

      // When they switch to another browser tab, mark all items as "seen"
      $(window).blur(function() {
        this.markAsSeen();
        this.updateTitle(0);
      }.bind(this));

      this.addKeyBindings();
      this.setupPreferences();

      // Update the todo lists every so often
      setInterval(this.update, this.props.pollInterval);
    },

    componentDidUpdate: function() {
      // turn timestamps into human times
      $(".timeago").timeago();
    },

    render: function() {
      return (
        React.createElement("div", null, 
          React.createElement(TodosLogin, {onLoginSubmit: this.handleLoginSubmit}), 
          React.createElement(TodoTabs, {tabs: tabs, data: this.state.data, 
                    selectedTab: this.state.selectedTab, 
                    includeBlockedBugs: this.state.includeBlockedBugs, 
                    onTabSelect: this.handleTabSelect})
        )
      );
    },

    /**
     * Get the user's email from the current url or storage.
     */
    loadUser: function() {
      // first see if the user is specified in the url
      var query = queryFromUrl();
      var email = query['email'];
      if (!email) {
        email = query['user'];
      }
      // if not, fetch the last user from storage
      if (!email) {
        email = TodosStorage.email;
        if (!email) {
          return null;
        }
      }
      return email;
    },

    /**
     * Reset the user by email, fetching new data and updating the lists.
     */
    setUser: function(email) {
      this.user = new BugzillaUser(email);

      TodosStorage.email = email;

      $("#login-container").removeClass("logged-out");
      $("#login-container").addClass("logged-in");
      $("#login-name").val(email);

      $("#welcome-message").hide();
      $("#todo-lists").show();
      $("footer").show();

      this.update();
    },

    /**
     * Fetch new data from Bugzilla and update the todo lists.
     */
    update: function() {
      this.user.fetchTodos(function(data) {
        var count = this.markNew(data);
        this.updateTitle(count);

        this.setState({data: data});
      }.bind(this));
    },

    /**
     * Mark which items in the fetched data are new since last time.
     * We need this to display the count of new items in the tab title
     * and favicon, and to visually highlight the new items in the list.
     */
    markNew: function(newData) {
      var oldData = this.state.data;
      var totalNew = 0; // number of new non-seen items

      for (var id in newData) {
        var newList = newData[id].items;
        var oldList = oldData[id].items;
        var newCount = 0;

        if (!newList || !oldList) {
          continue;
        }
        for (var i in newList) {
          // try to find this item in the old list
          var newItem = newList[i];
          var oldItem = null;
          for (var j in oldList) {
            if (newItem.bug.id == oldList[j].bug.id) {
              oldItem = oldList[j];
              break;
            }
          }
          // mark as new if there was no match in the old list, or
          // there is, but that item hasn't been seen yet by the user.
          var isNew = !oldItem || oldItem.new;
          if (isNew) {
            newCount++;
            totalNew++;
          }
          newItem.new = isNew;
        }
        // cache the count of new items for easy fetching
        newData[id].newCount = newCount;
      }

      return totalNew;
    },

    /**
     * Mark every item as "seen", thus clearing favicon and title counts
     * and removing the highlights from new items.
     */
    markAsSeen: function() {
      // mutate old state briefly
      var data = this.state.data;
      for (var id in data) {
        var list = data[id].items;
        if (!list) {
          continue;
        }

        for (var i in list) {
          list[i].new = false;
        }
      }
      // then reset state to old state but without markers
      this.setState(data);
    },

    /**
     * Update the page title to reflect the number of updates.
     */
    updateTitle: function(updateCount) {
      var title = document.title;
      title = title.replace(/\(\w+\) /, "");

      // update title with the number of new requests
      if (updateCount) {
        title = "(" + updateCount + ") " + title;
      }
      document.title = title;

      // update favicon too
      Tinycon.setBubble(updateCount);
    },

    /**
     * Start listening for key events for changing tabs.
     */
    addKeyBindings: function() {
      var keys = {
        'r': 'review',
        'c': 'checkin',
        'n': 'nag',
        'p': 'respond',
        'f': 'fix',
        'h': 'selectPreviousTab',
        'l': 'selectNextTab',
      };

      $(document).keypress(function(e) {
        if (e.ctrlKey || e.altKey || e.shiftKey || e.metaKey
           || e.target.nodeName.toLowerCase() == "input") {
          return;
        }
        var action = keys[String.fromCharCode(e.charCode)];
        if (!action) {
          return;
        }
        if (this.indexForTab(action) >= 0) {
          return void this.handleTabSelect(action);
        }
        if (typeof this[action] == "function") {
          return void this[action]();
        }
      }.bind(this));

      // Tell the user what keybindings exist.
      var keyInfo = $("#key-info");
      var firstIteration = true;
      for (var key in keys) {
        if (firstIteration) {
          firstIteration = false;
        } else {
          keyInfo.append(", ");
        }
        keyInfo.append($("<code>").append(key));
      }
    },

    selectNextTab: function() {
      this.selectTabRelative(1);
    },

    selectPreviousTab: function() {
      this.selectTabRelative(-1);
    },

    selectTabRelative: function (offset) {
      var N = tabs.length;
      var index = this.indexForTab(this.state.selectedTab);
      var tab = tabs[(index + offset + N) % N];

      this.handleTabSelect(tab.id);
    },

    indexForTab: function(listId) {
      for (var i = 0; i < tabs.length; i++) {
        if (tabs[i].id == listId) {
          return i;
        }
      }
      return -1;
    },

    setupPreferences: function () {
      var checkbox = $("#include-blocked-bugs");
      checkbox.attr("checked", TodosStorage.includeBlockedBugs);
      checkbox.change(this.setIncludeBlockedBugs);
    },

    setIncludeBlockedBugs: function(event) {
      var shouldInclude = event.target.checked;
      TodosStorage.includeBlockedBugs = shouldInclude;

      this.setState({includeBlockedBugs: shouldInclude});
    }
  });

  var TodosLogin = React.createClass({displayName: 'TodosLogin',
    /**
     * Handle login form submission. We're using a form here so we can take
     * advantage of the browser's native autocomplete for remembering emails.
     */
    handleSubmit: function(e) {
      e.preventDefault();

      var email = this.refs.email.getDOMNode().value.trim();
      this.props.onLoginSubmit(email);

      // We do all this so we get the native autocomplete for the email address
      // http://stackoverflow.com/questions/8400269/browser-native-autocomplete-for-ajaxed-forms
      var iFrameWindow = document.getElementById("submit-iframe").contentWindow;
      var cloned = document.getElementById("login-form").cloneNode(true);
      iFrameWindow.document.body.appendChild(cloned);
      var frameForm = iFrameWindow.document.getElementById("login-form");
      frameForm.onsubmit = null;
      frameForm.submit();
      return false;
    },

    componentDidMount: function() {
      var input = $(this.refs.email.getDOMNode());
      input.val(TodosStorage.email);

      input.click(function(){
        this.select();
      });
      // clicking outside of the login should change the user
      input.blur(function() {
        $("#login-form").submit();
      });
      // React won't catch the submission fired from the blur handler
      $("#login-form").submit(this.handleSubmit);
    },

    render: function() {
      return (
        React.createElement("div", {id: "login-container"}, 
          React.createElement("span", {id: "title"}, 
            React.createElement("img", {id: "bug-icon", src: "lib/bugzilla.png", alt: "Bugzilla"}), 
             "Todos"
          ), 
          React.createElement("span", {id: "login"}, " for", 
            React.createElement("form", {id: "login-form", onSubmit: this.handleSubmit}, 
              React.createElement("input", {id: "login-name", 
                     name: "email", placeholder: "Enter Bugzilla user...", 
                     ref: "email"})
            )
          )
        )
      );
    }
  })

  /**
   * Get an object with the query paramaters and values for the current page.
   */
  function queryFromUrl(url) {
    var vars = (url || document.URL).replace(/.+\?/, "").split("&"),
        query = {};
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split("=");
      query[pair[0]] = decodeURIComponent(pair[1]);
    }
    return query;
  }

  return TodosApp;
})();

$(document).ready(function() {
  var interval = 1000 * 60 * 20; // twenty minutes

  React.render(React.createElement(TodosApp, {pollInterval: interval}),
               document.getElementById("content"))
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtZWQuanMiLCJzb3VyY2VzIjpbbnVsbF0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHFCQUFxQjtBQUNyQixJQUFJLFFBQVEsR0FBRyxDQUFDLFdBQVc7RUFDekIsSUFBSSxJQUFJLEdBQUc7SUFDVCxFQUFFLEVBQUUsRUFBRSxRQUFRO01BQ1osSUFBSSxFQUFFLFdBQVc7TUFDakIsR0FBRyxFQUFFLHFDQUFxQztNQUMxQyxJQUFJLEVBQUUsU0FBUztLQUNoQjtJQUNELEVBQUUsRUFBRSxFQUFFLFNBQVM7TUFDYixJQUFJLEVBQUUsYUFBYTtNQUNuQixHQUFHLEVBQUUsNENBQTRDO01BQ2pELElBQUksRUFBRSxTQUFTO0tBQ2hCO0lBQ0QsRUFBRSxFQUFFLEVBQUUsS0FBSztNQUNULElBQUksRUFBRSxRQUFRO01BQ2QsR0FBRyxFQUFFLDBDQUEwQztNQUMvQyxJQUFJLEVBQUUsZUFBZTtLQUN0QjtJQUNELEVBQUUsRUFBRSxFQUFFLFNBQVM7TUFDYixJQUFJLEVBQUUsWUFBWTtNQUNsQixHQUFHLEVBQUUsNkNBQTZDO01BQ2xELElBQUksRUFBRSxPQUFPO0tBQ2Q7SUFDRCxFQUFFLEVBQUUsRUFBRSxLQUFLO01BQ1QsSUFBSSxFQUFFLFFBQVE7TUFDZCxHQUFHLEVBQUUsK0JBQStCO01BQ3BDLElBQUksRUFBRSxNQUFNO0tBQ2I7QUFDTCxHQUFHLENBQUM7O0VBRUYsSUFBSSxZQUFZLEdBQUc7SUFDakIsSUFBSSxLQUFLLEdBQUc7TUFDVixPQUFPLFlBQVksQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUMzQyxLQUFLOztJQUVELElBQUksS0FBSyxVQUFVO01BQ2pCLFlBQVksQ0FBQyxlQUFlLENBQUMsR0FBRyxPQUFPLENBQUM7QUFDOUMsS0FBSzs7SUFFRCxJQUFJLFdBQVcsR0FBRztNQUNoQixPQUFPLFlBQVksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2xELEtBQUs7O0lBRUQsSUFBSSxXQUFXLEtBQUs7TUFDbEIsWUFBWSxDQUFDLHNCQUFz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QyxHQUFHLElBQUksUUFBUSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7UUFDM0QsS0FBSyxHQUFHLEVBQUUsQ0FBQztJQUNmLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO01BQ3BDLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7TUFDOUIsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQzlDO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDakIsR0FBRzs7RUFFRCxPQUFPLFFBQVEsQ0FBQztBQUNsQixDQUFDLEdBQUcsQ0FBQzs7QUFFTCxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVc7QUFDN0IsRUFBRSxJQUFJLFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQzs7RUFFOUIsS0FBSyxDQUFDLE1BQU0sQ0FBQyxvQkFBQyxRQUFRLEVBQUEsQ0FBQSxDQUFDLFlBQUEsRUFBWSxDQUFFLFFBQVMsQ0FBRSxDQUFBO2VBQ25DLFFBQVEsQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7Q0FDakQsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqIEBqc3ggUmVhY3QuRE9NICovXG52YXIgVG9kb3NBcHAgPSAoZnVuY3Rpb24oKSB7XG4gIHZhciB0YWJzID0gW1xuICAgIHsgaWQ6IFwicmV2aWV3XCIsXG4gICAgICBuYW1lOiBcIlRvIFJldmlld1wiLFxuICAgICAgYWx0OiBcIlBhdGNoZXMgeW91IGhhdmUgdG8gcmV2aWV3IChrZXk6IHIpXCIsXG4gICAgICB0eXBlOiBcInBhdGNoZXNcIlxuICAgIH0sXG4gICAgeyBpZDogXCJjaGVja2luXCIsXG4gICAgICBuYW1lOiBcIlRvIENoZWNrIEluXCIsXG4gICAgICBhbHQ6IFwiUGF0Y2hlcyBieSB5b3UsIHJlYWR5IHRvIGNoZWNrIGluIChrZXk6IGMpXCIsXG4gICAgICB0eXBlOiBcInBhdGNoZXNcIlxuICAgIH0sXG4gICAgeyBpZDogXCJuYWdcIixcbiAgICAgIG5hbWU6IFwiVG8gTmFnXCIsXG4gICAgICBhbHQ6IFwiUGF0Y2hlcyBieSB5b3UsIGF3YWl0aW5nIHJldmlldyAoa2V5OiBuKVwiLFxuICAgICAgdHlwZTogXCJmbGFncytyZXZpZXdzXCJcbiAgICB9LFxuICAgIHsgaWQ6IFwicmVzcG9uZFwiLFxuICAgICAgbmFtZTogXCJUbyBSZXNwb25kXCIsXG4gICAgICBhbHQ6IFwiQnVncyB3aGVyZSB5b3UncmUgYSBmbGFnIHJlcXVlc3RlZSAoa2V5OiBwKVwiLFxuICAgICAgdHlwZTogXCJmbGFnc1wiXG4gICAgfSxcbiAgICB7IGlkOiBcImZpeFwiLFxuICAgICAgbmFtZTogXCJUbyBGaXhcIixcbiAgICAgIGFsdDogXCJCdWdzIGFzc2lnbmVkIHRvIHlvdSAoa2V5OiBmKVwiLFxuICAgICAgdHlwZTogXCJidWdzXCJcbiAgICB9XG4gIF07XG5cbiAgdmFyIFRvZG9zU3RvcmFnZSA9IHtcbiAgICBnZXQgZW1haWwoKSB7XG4gICAgICByZXR1cm4gbG9jYWxTdG9yYWdlWydienRvZG9zLWVtYWlsJ107XG4gICAgfSxcblxuICAgIHNldCBlbWFpbChhZGRyZXNzKSB7XG4gICAgICBsb2NhbFN0b3JhZ2VbXCJienRvZG9zLWVtYWlsXCJdID0gYWRkcmVzcztcbiAgICB9LFxuXG4gICAgZ2V0IHNlbGVjdGVkVGFiKCkge1xuICAgICAgcmV0dXJuIGxvY2FsU3RvcmFnZVsnYnp0b2Rvcy1zZWxlY3RlZC10YWInXTtcbiAgICB9LFxuXG4gICAgc2V0IHNlbGVjdGVkVGFiKGlkKSB7XG4gICAgICBsb2NhbFN0b3JhZ2VbJ2J6dG9kb3Mtc2VsZWN0ZWQtdGFiJ10gPSBpZDtcbiAgICB9LFxuXG4gICAgZ2V0IGluY2x1ZGVCbG9ja2VkQnVncygpIHtcbiAgICAgIC8vIGRlZmF1bHQgaXMgdHJ1ZVxuICAgICAgcmV0dXJuICEobG9jYWxTdG9yYWdlWydienRvZG9zLWluY2x1ZGUtYmxvY2tlZC1idWdzJ10gPT09IFwiZmFsc2VcIik7XG4gICAgfSxcblxuICAgIHNldCBpbmNsdWRlQmxvY2tlZEJ1Z3Moc2hvdWxkSW5jbHVkZSkge1xuICAgICAgbG9jYWxTdG9yYWdlWydienRvZG9zLWluY2x1ZGUtYmxvY2tlZC1idWdzJ10gPSBKU09OLnN0cmluZ2lmeShzaG91bGRJbmNsdWRlKTtcbiAgICB9XG4gIH1cblxuICB2YXIgVG9kb3NBcHAgPSBSZWFjdC5jcmVhdGVDbGFzcyh7XG4gICAgaGFuZGxlTG9naW5TdWJtaXQ6IGZ1bmN0aW9uKGVtYWlsKSB7XG4gICAgICBpZiAoIWVtYWlsIHx8IGVtYWlsID09IFRvZG9zU3RvcmFnZS5lbWFpbCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICB0aGlzLnNldFN0YXRlKHRoaXMuZ2V0SW5pdGlhbFN0YXRlKCkpO1xuICAgICAgdGhpcy5zZXRVc2VyKGVtYWlsKTtcbiAgICB9LFxuXG4gICAgaGFuZGxlVGFiU2VsZWN0OiBmdW5jdGlvbihsaXN0SWQpIHtcbiAgICAgIGlmIChsaXN0SWQgPT0gVG9kb3NTdG9yYWdlLnNlbGVjdGVkVGFiKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIFRvZG9zU3RvcmFnZS5zZWxlY3RlZFRhYiA9IGxpc3RJZDtcbiAgICAgIHRoaXMuc2V0U3RhdGUoe3NlbGVjdGVkVGFiOiBsaXN0SWR9KTtcbiAgICB9LFxuXG4gICAgZ2V0SW5pdGlhbFN0YXRlOiBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGRhdGE6IHtyZXZpZXc6IHt9LCBjaGVja2luOiB7fSwgbmFnOiB7fSwgcmVzcG9uZDoge30sIGZpeDoge319LFxuICAgICAgICBzZWxlY3RlZFRhYjogVG9kb3NTdG9yYWdlLnNlbGVjdGVkVGFiIHx8IFwicmV2aWV3XCIsXG4gICAgICAgIGluY2x1ZGVCbG9ja2VkQnVnczogVG9kb3NTdG9yYWdlLmluY2x1ZGVCbG9ja2VkQnVnc1xuICAgICAgfTtcbiAgICB9LFxuXG4gICAgY29tcG9uZW50RGlkTW91bnQ6IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGVtYWlsID0gdGhpcy5sb2FkVXNlcigpO1xuICAgICAgaWYgKCFlbWFpbCkge1xuICAgICAgICAkKFwiI2xvZ2luLWNvbnRhaW5lclwiKS5hZGRDbGFzcyhcImxvZ2dlZC1vdXRcIik7XG4gICAgICAgICQoXCIjdG9kby1saXN0c1wiKS5oaWRlKCk7XG4gICAgICAgICQoXCJmb290ZXJcIikuaGlkZSgpO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIHRoaXMuc2V0VXNlcihlbWFpbCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFdoZW4gdGhleSBzd2l0Y2ggdG8gYW5vdGhlciBicm93c2VyIHRhYiwgbWFyayBhbGwgaXRlbXMgYXMgXCJzZWVuXCJcbiAgICAgICQod2luZG93KS5ibHVyKGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLm1hcmtBc1NlZW4oKTtcbiAgICAgICAgdGhpcy51cGRhdGVUaXRsZSgwKTtcbiAgICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgICAgIHRoaXMuYWRkS2V5QmluZGluZ3MoKTtcbiAgICAgIHRoaXMuc2V0dXBQcmVmZXJlbmNlcygpO1xuXG4gICAgICAvLyBVcGRhdGUgdGhlIHRvZG8gbGlzdHMgZXZlcnkgc28gb2Z0ZW5cbiAgICAgIHNldEludGVydmFsKHRoaXMudXBkYXRlLCB0aGlzLnByb3BzLnBvbGxJbnRlcnZhbCk7XG4gICAgfSxcblxuICAgIGNvbXBvbmVudERpZFVwZGF0ZTogZnVuY3Rpb24oKSB7XG4gICAgICAvLyB0dXJuIHRpbWVzdGFtcHMgaW50byBodW1hbiB0aW1lc1xuICAgICAgJChcIi50aW1lYWdvXCIpLnRpbWVhZ28oKTtcbiAgICB9LFxuXG4gICAgcmVuZGVyOiBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxkaXY+XG4gICAgICAgICAgPFRvZG9zTG9naW4gb25Mb2dpblN1Ym1pdD17dGhpcy5oYW5kbGVMb2dpblN1Ym1pdH0vPlxuICAgICAgICAgIDxUb2RvVGFicyB0YWJzPXt0YWJzfSBkYXRhPXt0aGlzLnN0YXRlLmRhdGF9XG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkVGFiPXt0aGlzLnN0YXRlLnNlbGVjdGVkVGFifVxuICAgICAgICAgICAgICAgICAgICBpbmNsdWRlQmxvY2tlZEJ1Z3M9e3RoaXMuc3RhdGUuaW5jbHVkZUJsb2NrZWRCdWdzfVxuICAgICAgICAgICAgICAgICAgICBvblRhYlNlbGVjdD17dGhpcy5oYW5kbGVUYWJTZWxlY3R9Lz5cbiAgICAgICAgPC9kaXY+XG4gICAgICApO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIHVzZXIncyBlbWFpbCBmcm9tIHRoZSBjdXJyZW50IHVybCBvciBzdG9yYWdlLlxuICAgICAqL1xuICAgIGxvYWRVc2VyOiBmdW5jdGlvbigpIHtcbiAgICAgIC8vIGZpcnN0IHNlZSBpZiB0aGUgdXNlciBpcyBzcGVjaWZpZWQgaW4gdGhlIHVybFxuICAgICAgdmFyIHF1ZXJ5ID0gcXVlcnlGcm9tVXJsKCk7XG4gICAgICB2YXIgZW1haWwgPSBxdWVyeVsnZW1haWwnXTtcbiAgICAgIGlmICghZW1haWwpIHtcbiAgICAgICAgZW1haWwgPSBxdWVyeVsndXNlciddO1xuICAgICAgfVxuICAgICAgLy8gaWYgbm90LCBmZXRjaCB0aGUgbGFzdCB1c2VyIGZyb20gc3RvcmFnZVxuICAgICAgaWYgKCFlbWFpbCkge1xuICAgICAgICBlbWFpbCA9IFRvZG9zU3RvcmFnZS5lbWFpbDtcbiAgICAgICAgaWYgKCFlbWFpbCkge1xuICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gZW1haWw7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFJlc2V0IHRoZSB1c2VyIGJ5IGVtYWlsLCBmZXRjaGluZyBuZXcgZGF0YSBhbmQgdXBkYXRpbmcgdGhlIGxpc3RzLlxuICAgICAqL1xuICAgIHNldFVzZXI6IGZ1bmN0aW9uKGVtYWlsKSB7XG4gICAgICB0aGlzLnVzZXIgPSBuZXcgQnVnemlsbGFVc2VyKGVtYWlsKTtcblxuICAgICAgVG9kb3NTdG9yYWdlLmVtYWlsID0gZW1haWw7XG5cbiAgICAgICQoXCIjbG9naW4tY29udGFpbmVyXCIpLnJlbW92ZUNsYXNzKFwibG9nZ2VkLW91dFwiKTtcbiAgICAgICQoXCIjbG9naW4tY29udGFpbmVyXCIpLmFkZENsYXNzKFwibG9nZ2VkLWluXCIpO1xuICAgICAgJChcIiNsb2dpbi1uYW1lXCIpLnZhbChlbWFpbCk7XG5cbiAgICAgICQoXCIjd2VsY29tZS1tZXNzYWdlXCIpLmhpZGUoKTtcbiAgICAgICQoXCIjdG9kby1saXN0c1wiKS5zaG93KCk7XG4gICAgICAkKFwiZm9vdGVyXCIpLnNob3coKTtcblxuICAgICAgdGhpcy51cGRhdGUoKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRmV0Y2ggbmV3IGRhdGEgZnJvbSBCdWd6aWxsYSBhbmQgdXBkYXRlIHRoZSB0b2RvIGxpc3RzLlxuICAgICAqL1xuICAgIHVwZGF0ZTogZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLnVzZXIuZmV0Y2hUb2RvcyhmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgIHZhciBjb3VudCA9IHRoaXMubWFya05ldyhkYXRhKTtcbiAgICAgICAgdGhpcy51cGRhdGVUaXRsZShjb3VudCk7XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7ZGF0YTogZGF0YX0pO1xuICAgICAgfS5iaW5kKHRoaXMpKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogTWFyayB3aGljaCBpdGVtcyBpbiB0aGUgZmV0Y2hlZCBkYXRhIGFyZSBuZXcgc2luY2UgbGFzdCB0aW1lLlxuICAgICAqIFdlIG5lZWQgdGhpcyB0byBkaXNwbGF5IHRoZSBjb3VudCBvZiBuZXcgaXRlbXMgaW4gdGhlIHRhYiB0aXRsZVxuICAgICAqIGFuZCBmYXZpY29uLCBhbmQgdG8gdmlzdWFsbHkgaGlnaGxpZ2h0IHRoZSBuZXcgaXRlbXMgaW4gdGhlIGxpc3QuXG4gICAgICovXG4gICAgbWFya05ldzogZnVuY3Rpb24obmV3RGF0YSkge1xuICAgICAgdmFyIG9sZERhdGEgPSB0aGlzLnN0YXRlLmRhdGE7XG4gICAgICB2YXIgdG90YWxOZXcgPSAwOyAvLyBudW1iZXIgb2YgbmV3IG5vbi1zZWVuIGl0ZW1zXG5cbiAgICAgIGZvciAodmFyIGlkIGluIG5ld0RhdGEpIHtcbiAgICAgICAgdmFyIG5ld0xpc3QgPSBuZXdEYXRhW2lkXS5pdGVtcztcbiAgICAgICAgdmFyIG9sZExpc3QgPSBvbGREYXRhW2lkXS5pdGVtcztcbiAgICAgICAgdmFyIG5ld0NvdW50ID0gMDtcblxuICAgICAgICBpZiAoIW5ld0xpc3QgfHwgIW9sZExpc3QpIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBpIGluIG5ld0xpc3QpIHtcbiAgICAgICAgICAvLyB0cnkgdG8gZmluZCB0aGlzIGl0ZW0gaW4gdGhlIG9sZCBsaXN0XG4gICAgICAgICAgdmFyIG5ld0l0ZW0gPSBuZXdMaXN0W2ldO1xuICAgICAgICAgIHZhciBvbGRJdGVtID0gbnVsbDtcbiAgICAgICAgICBmb3IgKHZhciBqIGluIG9sZExpc3QpIHtcbiAgICAgICAgICAgIGlmIChuZXdJdGVtLmJ1Zy5pZCA9PSBvbGRMaXN0W2pdLmJ1Zy5pZCkge1xuICAgICAgICAgICAgICBvbGRJdGVtID0gb2xkTGlzdFtqXTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIG1hcmsgYXMgbmV3IGlmIHRoZXJlIHdhcyBubyBtYXRjaCBpbiB0aGUgb2xkIGxpc3QsIG9yXG4gICAgICAgICAgLy8gdGhlcmUgaXMsIGJ1dCB0aGF0IGl0ZW0gaGFzbid0IGJlZW4gc2VlbiB5ZXQgYnkgdGhlIHVzZXIuXG4gICAgICAgICAgdmFyIGlzTmV3ID0gIW9sZEl0ZW0gfHwgb2xkSXRlbS5uZXc7XG4gICAgICAgICAgaWYgKGlzTmV3KSB7XG4gICAgICAgICAgICBuZXdDb3VudCsrO1xuICAgICAgICAgICAgdG90YWxOZXcrKztcbiAgICAgICAgICB9XG4gICAgICAgICAgbmV3SXRlbS5uZXcgPSBpc05ldztcbiAgICAgICAgfVxuICAgICAgICAvLyBjYWNoZSB0aGUgY291bnQgb2YgbmV3IGl0ZW1zIGZvciBlYXN5IGZldGNoaW5nXG4gICAgICAgIG5ld0RhdGFbaWRdLm5ld0NvdW50ID0gbmV3Q291bnQ7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0b3RhbE5ldztcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogTWFyayBldmVyeSBpdGVtIGFzIFwic2VlblwiLCB0aHVzIGNsZWFyaW5nIGZhdmljb24gYW5kIHRpdGxlIGNvdW50c1xuICAgICAqIGFuZCByZW1vdmluZyB0aGUgaGlnaGxpZ2h0cyBmcm9tIG5ldyBpdGVtcy5cbiAgICAgKi9cbiAgICBtYXJrQXNTZWVuOiBmdW5jdGlvbigpIHtcbiAgICAgIC8vIG11dGF0ZSBvbGQgc3RhdGUgYnJpZWZseVxuICAgICAgdmFyIGRhdGEgPSB0aGlzLnN0YXRlLmRhdGE7XG4gICAgICBmb3IgKHZhciBpZCBpbiBkYXRhKSB7XG4gICAgICAgIHZhciBsaXN0ID0gZGF0YVtpZF0uaXRlbXM7XG4gICAgICAgIGlmICghbGlzdCkge1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yICh2YXIgaSBpbiBsaXN0KSB7XG4gICAgICAgICAgbGlzdFtpXS5uZXcgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy8gdGhlbiByZXNldCBzdGF0ZSB0byBvbGQgc3RhdGUgYnV0IHdpdGhvdXQgbWFya2Vyc1xuICAgICAgdGhpcy5zZXRTdGF0ZShkYXRhKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIHRoZSBwYWdlIHRpdGxlIHRvIHJlZmxlY3QgdGhlIG51bWJlciBvZiB1cGRhdGVzLlxuICAgICAqL1xuICAgIHVwZGF0ZVRpdGxlOiBmdW5jdGlvbih1cGRhdGVDb3VudCkge1xuICAgICAgdmFyIHRpdGxlID0gZG9jdW1lbnQudGl0bGU7XG4gICAgICB0aXRsZSA9IHRpdGxlLnJlcGxhY2UoL1xcKFxcdytcXCkgLywgXCJcIik7XG5cbiAgICAgIC8vIHVwZGF0ZSB0aXRsZSB3aXRoIHRoZSBudW1iZXIgb2YgbmV3IHJlcXVlc3RzXG4gICAgICBpZiAodXBkYXRlQ291bnQpIHtcbiAgICAgICAgdGl0bGUgPSBcIihcIiArIHVwZGF0ZUNvdW50ICsgXCIpIFwiICsgdGl0bGU7XG4gICAgICB9XG4gICAgICBkb2N1bWVudC50aXRsZSA9IHRpdGxlO1xuXG4gICAgICAvLyB1cGRhdGUgZmF2aWNvbiB0b29cbiAgICAgIFRpbnljb24uc2V0QnViYmxlKHVwZGF0ZUNvdW50KTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgbGlzdGVuaW5nIGZvciBrZXkgZXZlbnRzIGZvciBjaGFuZ2luZyB0YWJzLlxuICAgICAqL1xuICAgIGFkZEtleUJpbmRpbmdzOiBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBrZXlzID0ge1xuICAgICAgICAncic6ICdyZXZpZXcnLFxuICAgICAgICAnYyc6ICdjaGVja2luJyxcbiAgICAgICAgJ24nOiAnbmFnJyxcbiAgICAgICAgJ3AnOiAncmVzcG9uZCcsXG4gICAgICAgICdmJzogJ2ZpeCcsXG4gICAgICAgICdoJzogJ3NlbGVjdFByZXZpb3VzVGFiJyxcbiAgICAgICAgJ2wnOiAnc2VsZWN0TmV4dFRhYicsXG4gICAgICB9O1xuXG4gICAgICAkKGRvY3VtZW50KS5rZXlwcmVzcyhmdW5jdGlvbihlKSB7XG4gICAgICAgIGlmIChlLmN0cmxLZXkgfHwgZS5hbHRLZXkgfHwgZS5zaGlmdEtleSB8fCBlLm1ldGFLZXlcbiAgICAgICAgICAgfHwgZS50YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PSBcImlucHV0XCIpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGFjdGlvbiA9IGtleXNbU3RyaW5nLmZyb21DaGFyQ29kZShlLmNoYXJDb2RlKV07XG4gICAgICAgIGlmICghYWN0aW9uKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmluZGV4Rm9yVGFiKGFjdGlvbikgPj0gMCkge1xuICAgICAgICAgIHJldHVybiB2b2lkIHRoaXMuaGFuZGxlVGFiU2VsZWN0KGFjdGlvbik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiB0aGlzW2FjdGlvbl0gPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgcmV0dXJuIHZvaWQgdGhpc1thY3Rpb25dKCk7XG4gICAgICAgIH1cbiAgICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgICAgIC8vIFRlbGwgdGhlIHVzZXIgd2hhdCBrZXliaW5kaW5ncyBleGlzdC5cbiAgICAgIHZhciBrZXlJbmZvID0gJChcIiNrZXktaW5mb1wiKTtcbiAgICAgIHZhciBmaXJzdEl0ZXJhdGlvbiA9IHRydWU7XG4gICAgICBmb3IgKHZhciBrZXkgaW4ga2V5cykge1xuICAgICAgICBpZiAoZmlyc3RJdGVyYXRpb24pIHtcbiAgICAgICAgICBmaXJzdEl0ZXJhdGlvbiA9IGZhbHNlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGtleUluZm8uYXBwZW5kKFwiLCBcIik7XG4gICAgICAgIH1cbiAgICAgICAga2V5SW5mby5hcHBlbmQoJChcIjxjb2RlPlwiKS5hcHBlbmQoa2V5KSk7XG4gICAgICB9XG4gICAgfSxcblxuICAgIHNlbGVjdE5leHRUYWI6IGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy5zZWxlY3RUYWJSZWxhdGl2ZSgxKTtcbiAgICB9LFxuXG4gICAgc2VsZWN0UHJldmlvdXNUYWI6IGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy5zZWxlY3RUYWJSZWxhdGl2ZSgtMSk7XG4gICAgfSxcblxuICAgIHNlbGVjdFRhYlJlbGF0aXZlOiBmdW5jdGlvbiAob2Zmc2V0KSB7XG4gICAgICB2YXIgTiA9IHRhYnMubGVuZ3RoO1xuICAgICAgdmFyIGluZGV4ID0gdGhpcy5pbmRleEZvclRhYih0aGlzLnN0YXRlLnNlbGVjdGVkVGFiKTtcbiAgICAgIHZhciB0YWIgPSB0YWJzWyhpbmRleCArIG9mZnNldCArIE4pICUgTl07XG5cbiAgICAgIHRoaXMuaGFuZGxlVGFiU2VsZWN0KHRhYi5pZCk7XG4gICAgfSxcblxuICAgIGluZGV4Rm9yVGFiOiBmdW5jdGlvbihsaXN0SWQpIHtcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGFicy5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAodGFic1tpXS5pZCA9PSBsaXN0SWQpIHtcbiAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIC0xO1xuICAgIH0sXG5cbiAgICBzZXR1cFByZWZlcmVuY2VzOiBmdW5jdGlvbiAoKSB7XG4gICAgICB2YXIgY2hlY2tib3ggPSAkKFwiI2luY2x1ZGUtYmxvY2tlZC1idWdzXCIpO1xuICAgICAgY2hlY2tib3guYXR0cihcImNoZWNrZWRcIiwgVG9kb3NTdG9yYWdlLmluY2x1ZGVCbG9ja2VkQnVncyk7XG4gICAgICBjaGVja2JveC5jaGFuZ2UodGhpcy5zZXRJbmNsdWRlQmxvY2tlZEJ1Z3MpO1xuICAgIH0sXG5cbiAgICBzZXRJbmNsdWRlQmxvY2tlZEJ1Z3M6IGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgICB2YXIgc2hvdWxkSW5jbHVkZSA9IGV2ZW50LnRhcmdldC5jaGVja2VkO1xuICAgICAgVG9kb3NTdG9yYWdlLmluY2x1ZGVCbG9ja2VkQnVncyA9IHNob3VsZEluY2x1ZGU7XG5cbiAgICAgIHRoaXMuc2V0U3RhdGUoe2luY2x1ZGVCbG9ja2VkQnVnczogc2hvdWxkSW5jbHVkZX0pO1xuICAgIH1cbiAgfSk7XG5cbiAgdmFyIFRvZG9zTG9naW4gPSBSZWFjdC5jcmVhdGVDbGFzcyh7XG4gICAgLyoqXG4gICAgICogSGFuZGxlIGxvZ2luIGZvcm0gc3VibWlzc2lvbi4gV2UncmUgdXNpbmcgYSBmb3JtIGhlcmUgc28gd2UgY2FuIHRha2VcbiAgICAgKiBhZHZhbnRhZ2Ugb2YgdGhlIGJyb3dzZXIncyBuYXRpdmUgYXV0b2NvbXBsZXRlIGZvciByZW1lbWJlcmluZyBlbWFpbHMuXG4gICAgICovXG4gICAgaGFuZGxlU3VibWl0OiBmdW5jdGlvbihlKSB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgIHZhciBlbWFpbCA9IHRoaXMucmVmcy5lbWFpbC5nZXRET01Ob2RlKCkudmFsdWUudHJpbSgpO1xuICAgICAgdGhpcy5wcm9wcy5vbkxvZ2luU3VibWl0KGVtYWlsKTtcblxuICAgICAgLy8gV2UgZG8gYWxsIHRoaXMgc28gd2UgZ2V0IHRoZSBuYXRpdmUgYXV0b2NvbXBsZXRlIGZvciB0aGUgZW1haWwgYWRkcmVzc1xuICAgICAgLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy84NDAwMjY5L2Jyb3dzZXItbmF0aXZlLWF1dG9jb21wbGV0ZS1mb3ItYWpheGVkLWZvcm1zXG4gICAgICB2YXIgaUZyYW1lV2luZG93ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzdWJtaXQtaWZyYW1lXCIpLmNvbnRlbnRXaW5kb3c7XG4gICAgICB2YXIgY2xvbmVkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJsb2dpbi1mb3JtXCIpLmNsb25lTm9kZSh0cnVlKTtcbiAgICAgIGlGcmFtZVdpbmRvdy5kb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGNsb25lZCk7XG4gICAgICB2YXIgZnJhbWVGb3JtID0gaUZyYW1lV2luZG93LmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwibG9naW4tZm9ybVwiKTtcbiAgICAgIGZyYW1lRm9ybS5vbnN1Ym1pdCA9IG51bGw7XG4gICAgICBmcmFtZUZvcm0uc3VibWl0KCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSxcblxuICAgIGNvbXBvbmVudERpZE1vdW50OiBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBpbnB1dCA9ICQodGhpcy5yZWZzLmVtYWlsLmdldERPTU5vZGUoKSk7XG4gICAgICBpbnB1dC52YWwoVG9kb3NTdG9yYWdlLmVtYWlsKTtcblxuICAgICAgaW5wdXQuY2xpY2soZnVuY3Rpb24oKXtcbiAgICAgICAgdGhpcy5zZWxlY3QoKTtcbiAgICAgIH0pO1xuICAgICAgLy8gY2xpY2tpbmcgb3V0c2lkZSBvZiB0aGUgbG9naW4gc2hvdWxkIGNoYW5nZSB0aGUgdXNlclxuICAgICAgaW5wdXQuYmx1cihmdW5jdGlvbigpIHtcbiAgICAgICAgJChcIiNsb2dpbi1mb3JtXCIpLnN1Ym1pdCgpO1xuICAgICAgfSk7XG4gICAgICAvLyBSZWFjdCB3b24ndCBjYXRjaCB0aGUgc3VibWlzc2lvbiBmaXJlZCBmcm9tIHRoZSBibHVyIGhhbmRsZXJcbiAgICAgICQoXCIjbG9naW4tZm9ybVwiKS5zdWJtaXQodGhpcy5oYW5kbGVTdWJtaXQpO1xuICAgIH0sXG5cbiAgICByZW5kZXI6IGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgPGRpdiBpZD1cImxvZ2luLWNvbnRhaW5lclwiPlxuICAgICAgICAgIDxzcGFuIGlkPVwidGl0bGVcIj5cbiAgICAgICAgICAgIDxpbWcgaWQ9XCJidWctaWNvblwiIHNyYz1cImxpYi9idWd6aWxsYS5wbmdcIiBhbHQ9XCJCdWd6aWxsYVwiPjwvaW1nPlxuICAgICAgICAgICAgIFRvZG9zXG4gICAgICAgICAgPC9zcGFuPlxuICAgICAgICAgIDxzcGFuIGlkPVwibG9naW5cIj4gZm9yXG4gICAgICAgICAgICA8Zm9ybSBpZD1cImxvZ2luLWZvcm1cIiBvblN1Ym1pdD17dGhpcy5oYW5kbGVTdWJtaXR9PlxuICAgICAgICAgICAgICA8aW5wdXQgaWQ9XCJsb2dpbi1uYW1lXCJcbiAgICAgICAgICAgICAgICAgICAgIG5hbWU9XCJlbWFpbFwiIHBsYWNlaG9sZGVyPVwiRW50ZXIgQnVnemlsbGEgdXNlci4uLlwiXG4gICAgICAgICAgICAgICAgICAgICByZWY9XCJlbWFpbFwiLz5cbiAgICAgICAgICAgIDwvZm9ybT5cbiAgICAgICAgICA8L3NwYW4+XG4gICAgICAgIDwvZGl2PlxuICAgICAgKTtcbiAgICB9XG4gIH0pXG5cbiAgLyoqXG4gICAqIEdldCBhbiBvYmplY3Qgd2l0aCB0aGUgcXVlcnkgcGFyYW1hdGVycyBhbmQgdmFsdWVzIGZvciB0aGUgY3VycmVudCBwYWdlLlxuICAgKi9cbiAgZnVuY3Rpb24gcXVlcnlGcm9tVXJsKHVybCkge1xuICAgIHZhciB2YXJzID0gKHVybCB8fCBkb2N1bWVudC5VUkwpLnJlcGxhY2UoLy4rXFw/LywgXCJcIikuc3BsaXQoXCImXCIpLFxuICAgICAgICBxdWVyeSA9IHt9O1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFycy5sZW5ndGg7IGkrKykge1xuICAgICAgdmFyIHBhaXIgPSB2YXJzW2ldLnNwbGl0KFwiPVwiKTtcbiAgICAgIHF1ZXJ5W3BhaXJbMF1dID0gZGVjb2RlVVJJQ29tcG9uZW50KHBhaXJbMV0pO1xuICAgIH1cbiAgICByZXR1cm4gcXVlcnk7XG4gIH1cblxuICByZXR1cm4gVG9kb3NBcHA7XG59KSgpO1xuXG4kKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHtcbiAgdmFyIGludGVydmFsID0gMTAwMCAqIDYwICogMjA7IC8vIHR3ZW50eSBtaW51dGVzXG5cbiAgUmVhY3QucmVuZGVyKDxUb2Rvc0FwcCBwb2xsSW50ZXJ2YWw9e2ludGVydmFsfS8+LFxuICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJjb250ZW50XCIpKVxufSk7XG4iXX0=